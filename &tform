FTN4,X
      SUBROUTINE TFORM(IP),SPECIFY TAPE FORMAT C#780803:09:24#
C 
C   TPFORM reads the a priori head offsets for each tape pass number
C 
C     INPUT VARIABLES:
      DIMENSION IP(1) 
C        IP(1)  - class number of input parameter buffer. 
C 
C     OUTPUT VARIABLES: 
C        IP(1) - CLASS
C        IP(2) - # REC
C        IP(3) - ERROR
C        IP(4) - who we are 
C 
C   COMMON BLOCKS USED
      INCLUDE #FSCOM::FS
C       contains array ITAPOF 
C 
C     CALLED SUBROUTINES: GTPRM,ISCNC 
C 
C   LOCAL VARIABLES 
C        NCHAR  - number of characters in buffer
C        ICH    - character counter 
      DIMENSION IBUF(40)
C               - class buffer
      LOGICAL PASSNO
C               - keeps track of whether parameter is a pass # or head offset 
C        ILEN   - length of IBUF, chars 
      DIMENSION IPARM(2)
C               - parameters returned from GTPRM
      DIMENSION IREG(2) 
C               - registers from EXEC calls 
      DIMENSION IPASS(20),IOFSET(20)  
C               - paired pass numbers and head offsets
C 
      EQUIVALENCE (REG,IREG(1)),(PARM,IPARM(1)) 
C 
C   LOCAL CONSTANTS 
      DATA MXPASS,MAXOFF,MINOFF/100,1500,-1500/   
      DATA ILEN/80/ 
C 
C 
C  PROGRAMMER: LAR
C     LAST MODIFIED: 15 JUNE 1988 FOR VERSION 5.8 
C 
C     1. Set output parameters (except error flag) and read from input
C     class into local buffer IBUF. 
C 
      ICLCM = IP(1) 
      IQCLAS = 0
      IP(1)=IQCLAS
      IP(2)=0 
      IP(4)=2HQ^
      IF (ICLCM.NE.0) GOTO 110
        IP(3) = -1
        RETURN
110   REG = EXEC(21,ICLCM,IBUF,-ILEN) 
      NCHAR = IREG(2) 
C           Scan for "="; its absence indicates a request to see
C             the contents of the ITAPOF array. 
      IEQ = ISCNC(IBUF,1,NCHAR,75B) 
      IF (IEQ.NE.0) GOTO 200
        NCHAR = 1 
        NREC = 0
        DO 180 I=1,MXPASS 
          IF (ITAPOF(I).LT.MINOFF .OR. ITAPOF(I).GT.MAXOFF) GOTO 180
            NCHAR = ICHMV(IBUF,NCHAR,2H  ,1,2)
            NCHAR = NCHAR + IB2AS(I,IBUF,NCHAR,100003B) 
            NCHAR = ICHMV(IBUF,NCHAR,2H->,1,2)
            NCHAR = NCHAR + IB2AS(ITAPOF(I),IBUF,NCHAR,100005B) 
            IF (NCHAR.LE.58) GOTO 180 
              CALL EXEC(20,0,IBUF,1-NCHAR,2HFS,0,IQCLAS)
              NCHAR = 1 
              NREC = NREC + 1 
180     CONTINUE
        IF (NCHAR.LE.1) GOTO 190
          CALL EXEC(20,0,IBUF,1-NCHAR,2HFS,0,IQCLAS)
          NREC = NREC + 1 
190     CONTINUE
        IP(1)=IQCLAS
        IP(2)=NREC
        IP(3)=0 
        RETURN
C 
C     2. Step through buffer getting each parameter and decoding it.
C     Command from user has these parameters: 
C           TAPEFORM=<pass>,<offset>,<pass>,<offset>, ... 
C 
200   ICH = 1+IEQ 
      DO 290 N=1,40 
        M=(N+1)/2 
        PASSNO = (M+M.NE.N) 
        CALL GTPRM(IBUF,ICH,NCHAR,1,PARM,IERR)
        IF (IPARM(1).GE.MINOFF.AND.IPARM(1).LE.MAXOFF.AND.((.NOT.PASSNO)
     ^     .OR. (IPARM(1).LE.MXPASS .AND. IPARM(1).GT.0) ) ) GOTO 210 
          IP(3) = -201
          RETURN
210     CONTINUE
        IF (PASSNO) IPASS(M)=IPARM(1) 
        IF (.NOT.PASSNO) IOFSET(M)=IPARM(1) 
        IF (ICH.LE.NCHAR) GOTO 290
          IF (PASSNO) IP(3)=-3
          IF (PASSNO) RETURN
          DO 240 I=1,M
            ITAPOF(IPASS(I)) = IOFSET(I)  
240       CONTINUE
          IP(3) = 0 
          RETURN
290   CONTINUE
      IP(3) = -42 
      RETURN
      END 
