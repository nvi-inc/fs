FTN4,X
C@IB
      SUBROUTINE IB(IP),HPIB COMMUNICATIONS C#870115:04:36# 
C 
C  IB transmits a buffer to HPIB
C 
C     INPUT VARIABLES:
C 
      DIMENSION IP(1) 
C        IP(1)  - class number of input parameter buffer. 
C 
C     OUTPUT VARIABLES: 
C 
C        IP(1) - CLASS #
C        IP(2) - # RECORDS IN CLASS 
C        IP(3) - ERROR
C        IP(4) - who we are 
C 
      INCLUDE #FSCOM::FS
C 
C     CALLED SUBROUTINES: CHARACTER ROUTINES
C 
C   LOCAL VARIABLES 
C 
C        NCHAR  - number of characters in buffer
C        NCH    - character counter 
C        ICOM    - character index of comma 
      DIMENSION IBUF(20)
C               - class buffer
      DIMENSION IBUF2(20) 
C               - output buffer for transmission
C        ILEN   - length of IBUF, chars 
      DIMENSION IREG(2) 
C               - registers from EXEC calls 
      DIMENSION IPARM(2)
C              - parameters from GTPARM 
C 
      EQUIVALENCE (REG,IREG(1)) 
      EQUIVALENCE (PARM,IPARM(1)) 
C 
C 
C 5.  INITIALIZED VARIABLES 
C 
      DATA ILEN/40/ 
C 
C 6.  PROGRAMMER: NRV 
C     LAST MODIFIED: CREATED  790309
C 
C 
C     1. Get the class buffer.  Messages for the HPIB consist of
C     the LU followed by data, separated by commas. 
C 
      ICLCM = IP(1) 
      IF (ICLCM.NE.0) GOTO 110
100   IERR = -1 
      GOTO 990
110   REG = EXEC(21,ICLCM,IBUF,-ILEN) 
      NCHAR = MIN0(IREG(2),ILEN)
      IEQ = ISCNC(IBUF,1,NCHAR,75B) 
C                   Scan for "="
      IF (IEQ.EQ.0) GOTO 100
C 
      NREC = 0
      ICLASS = 0
      IFC = 1+IEQ 
C 
200   CALL GTPRM(IBUF,IFC,NCHAR,1,PARM) 
C                   Scan for a number, the LU 
      IF (ICHAR(PARM,1).NE.54B) GOTO 210
C                   There are no defaults 
      IERR = -101 
      GOTO 990
C 
210   IBUF2(2) = IPARM
C                   Put LU into second word for IBCON 
      IF (NCHAR.GE.IFC) GOTO 220
      IBUF2(1) = -1 
C                   Read from LU, mode=1
      NCH = 4 
      GOTO 230
220   IBUF2(1) = -2 
C                   Write data to LU, mode=-2 
      NCH = NCHAR - IFC + 1 
      CALL ICHMV(IBUF2,5,IBUF,IFC,NCH)
C                   Move data characters from command to buffer 
      NCH = NCH + 4 
230   CALL EXEC(20,0,IBUF2,-NCH,2HFS,0,ICLASS)  
      IERR = 0
      IF (ICLASS.NE.0) GOTO 980 
      IERR = -1 
      GOTO 990
980   CALL EXEC(23,6HIBCON ,ICLASS,1) 
      CALL RMPAR(IP)
      CALL DEVDS(IP,ICLCM,0)
      RETURN
C 
990   IP(1) = 0 
      IP(2) = 0 
      IP(3) = IERR
      IP(4) = 2HQB
      RETURN
      END 
