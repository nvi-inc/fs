FTN4,X
C@LABEL 
      SUBROUTINE LABEL(IP),CHECK-LABEL COMMANDC#870115:04:41# 
C 
C     INPUT VARIABLES:
C 
      DIMENSION IP(1) 
C        IP(1)  - class number of input parameter buffer. 
C 
C     OUTPUT VARIABLES: 
C 
C        IP(1) - error
C        IP(2) - class
C        IP(3) - number of records
C        IP(4) - who we are 
C 
C 2.2.   COMMON BLOCKS USED 
C 
      INCLUDE #FSCOM::FS
C 
C 2.5.   SUBROUTINE INTERFACE:
C 
C     CALLING SUBROUTINES:
C 
C     CALLED SUBROUTINES: GTPRM,ICHAR 
C 
C 3.  LOCAL VARIABLES 
C 
      DIMENSION IPARM(2)
      DIMENSION IREG(2) 
C        NCHAR  - number of characters in buffer
C     ILEN - length of buffer IBUF
C        ICH    - character counter 
      DIMENSION IBUF(40)
C               - class buffer
      DIMENSION LNUM(4),LCHK(2) 
C                   - holders for tape number, check label
C                   - program to be RPed, buffer for status request 
      EQUIVALENCE (IREG(1),REG), (IPARM(1),PARM)
      DATA ILEN/80/ 
C 
C     1. First check out the input variables.  Then get the command 
C     into a buffer and find the "=" to determine whether to check or 
C     report the tape info. 
C 
      ICLCM = IP(1) 
      IF (ICLCM.NE.0) GOTO 110
      IERR = -1 
      GOTO 990
C 
110   REG = EXEC(21,ICLCM,IBUF,-ILEN) 
      NCHAR = MIN0(IREG(2),ILEN)
C 
      IEQ = ISCNC(IBUF,1,NCHAR,75B) 
C                              "="
      IF (IEQ.EQ.0) GOTO 500
C 
C 
C     2. Now check out the command. 
C     2.1 First parameter: tape number. 
C 
210   ICH = 1+IEQ 
      CALL GTPRM(IBUF,ICH,NCHAR,0,PARM) 
      IF (ICHAR(PARM,1).NE.52B.AND.ICHAR(PARM,1).NE.54B) GOTO 211 
      IERR = -101 
C                   No default, no old value
      GOTO 990
211   IF (ICH-IEQ-2.EQ.8) GOTO 212
      IERR = -201 
      GOTO 990
212   CALL ICHMV(LNUM,1,IBUF,1+IEQ,8) 
C                   Move exactly 8 characters into temp number
C 
C     2.2 Next parameter is the check label.
C 
220   CALL GTPRM(IBUF,ICH,NCHAR,0,PARM) 
      IF (ICHAR(PARM,1).NE.52B.AND.ICHAR(PARM,1).NE.54B) GOTO 221 
      IERR = -102 
C                   No default, no old value
      GOTO 990
221   DO 222 I=1,4
        IF (ICHAR(PARM,I).EQ.117B) CALL ICHMV(PARM,I,60B,2,1) 
C                             "O"                    "0"
222     CONTINUE
C                   Change any O to 0 in check label
C 
C     2.3 Generate check label.  Change any "O" to "0" in tape number first.
C     Then hash up the tape number (first parameter in command).
C 
      DO 322 I=1,8
        IF (ICHAR(LNUM,I).EQ.117B) CALL ICHMV(LNUM,I,60B,2,1) 
C                            "O"                     "0"
322     CONTINUE
C 
      ICODE = IHASH(LNUM,1,8) 
      LCHK(1) = IH22A(ICHAR(ICODE,1)) 
      LCHK(2) = IH22A(ICODE)
D     WRITE(LU,9901) LNUM,ICODE 
D9901 FORMAT(4A2," HASHES TO "O6) 
C 
C     2.4 Now LCHK contains the four hex characters in the correct
C     check label.  
C 
      IF (ICHCM(LCHK,1,PARM,1,4).EQ.0) GOTO 300 
      IERR = -202 
C                   The check labels didn't match 
      GOTO 990
C 
C 
C     3. Now plant the new tape number and check label in COMMON. 
C     Undo BOSS's HALT command so the schedule can proceed. 
C 
300   CALL ICHMV(LTPNUM,1,LNUM,1,8) 
      CALL ICHMV(LTPCHK,1,LCHK,1,4) 
C 
C     4. Schedule PRLAB to print tape label if next parameter is P. 
C        Queue schedule, no wait. 
C 
      CALL GTPRM(IBUF,ICH,NCHAR,0,PARM) 
      IF(IPARM.NE.2HP ) GOTO 490
C  Find out whether PRLAB is RPed already 
      IF(IPGST(6HPRLAB ).NE.-1) GOTO 310
C  If not, RP it now
          IF(IRP(6HPRLAB ,0,IERR,0).GE.0) GOTO 310
            IERR=-301 
            GOTO 490
310     CALL EXEC(24,6HPRLAB ,LU,2) 
490   KHALT=.FALSE. 
      IERR=0
      GOTO 990
C 
C 
C     5. Respond with current tape number and check label.
C 
500   NCH = ICHMV(IBUF,NCHAR+1,2H/ ,1,1)
      NCH = ICHMV(IBUF,NCH,LTPNUM,1,8)
      NCH = MCOMA(IBUF,NCH) 
      NCH = ICHMV(IBUF,NCH,LTPCHK,1,4) - 1
C 
      ICLASS = 0
      CALL EXEC(20,0,IBUF,-NCH,2HFS,0,ICLASS) 
C 
      IP(1) = ICLASS
      IP(2) = 1 
      IERR = 0
      GOTO 999
C 
C 
990   IP(1) = 0 
      IP(2) = 0 
999   IP(3) = IERR
      IP(4) = 2HQA
      RETURN
      END 
