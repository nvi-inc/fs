FTN4,X
C@PFBLK 
C 
      SUBROUTINE PFBLK(KBLK,LP,LFR),FIELD SYSTEM FMGR C#870115:05:40
C 
C     PFBLK 
C 
C 1.  PFBLK PROGRAM SPECIFICATION 
C 
C 1.1.   PFBLK interfaces PFMED with BOSS using a resource number.  
C        When PFMED is ready to read or alter a file, PFMED is called to
C        lock the status of the procedure files.  If there is a second copy,
C        PFBLK returns the correct file name for reading. 
C 
C 1.2.   RESTRICTIONS - Only procedure files are accessible.  These have
C        the prefix "[PRC" which is transparent to the user.  Procedures are
C        available only on disc ICRPRC.  The resource number must be
C        allocated by OPRIN.
C 
C 1.3.   REFERENCES - Field System Manual 
C 
C 2.  PFBLK INTERFACE 
C 
C 2.1.   CALLING SEQUENCE: CALL PFBLK(KBLK,LP,LFR)
C 
C     INPUT VARIABLES:
C 
C        KBLK    - control flag (1 - about to read, 2 - finished reading, 
C                  3 - about to replace file, 4 - error after 1 or 2) 
C        LP      - target procedure file
      DIMENSION LFR(3)
C                - correct file name for reading
C 
C 2.2.   COMMON BLOCKS USED:
C 
      INCLUDE #PFMED::56
C 
      INCLUDE #FSCOM::56
C 
C        LSKD    - current schedule 
C        LPRC    - current station procedure file 
C        LNEWSK  - flag for 2nd copy of schedule procedure file 
C                  (<>0 if copy exists) 
C        LNEWPR  - flag for 2nd copy of station procedure file
C 
C 2.3.   DATA BASE ACCESSES: none 
C 
C 2.4.   EXTERNAL INPUT/OUTPUT
C 
C     INPUT VARIABLES: none 
C 
C     OUTPUT VARIABLES: none
C 
C 2.5.   SUBROUTINE INTERFACE:
C 
C     CALLING SUBROUTINES: KCOPY, FFM, FFMP 
C 
C     CALLED SUBROUTINES: FMP routines,  EXEC, RNRQ 
C 
C 3.  LOCAL VARIABLES: none 
C 
C 
C 4.  CONSTANTS USED none 
C 
C 
C 5.  INITIALIZED VARIABLES:
C 
C 6.  PROGRAMMER: C. Ma 
C     LAST MODIFIED: <810113.0039>
C# LAST COMPC'ED  870115:05:40
C 
C     PROGRAM STRUCTURE 
D     WRITE(LU,9901) KBLK,LFR,LP
D9901 FORMAT("IN PFBLK: KBLK,LFR,LP="I3,1X,3A2,1X,A2) 
D     WRITE(LU,9902) LSKD,LPRC,LNEWSK,LNEWPR
D9902 FORMAT("          LSKD,LPRC,LNEWSK,LNEWPR="4("."A2".")) 
C 
      GO TO (100,200,300,400),KBLK
C     Before reading a procedure file.
100   CONTINUE
C     Lock BOSS.
      IF(IPGST(6HBOSS  ).EQ.-1) GO TO 105 
      CALL RNRQ(1,IRNPRC,ISTAT) 
D     WRITE(LU,9903) IRNPRC,ISTAT 
D9903 FORMAT("PFMED LOCKING RN "2O7)
C     Set name. 
105   LFR(2)=2HRC 
      LFR(3)=LP 
C     If file to be read is not second copy, release lock.
      IF(LP.NE.LNEWSK.AND.LP.NE.LNEWPR) 110,120 
C     Set file name for reading.
110   LFR(1)=2H[P 
      IF(IPGST(6HBOSS  ).EQ.-1) GO TO 900 
      CALL RNRQ(4,IRNPRC,ISTAT) 
D     WRITE(LU,9904) IRNPRC,ISTAT 
D9904 FORMAT("PRMED UNLOCKING RN "2O7)
      GO TO 900 
C     Set name to second copy for reading.
120   LFR(1)=2H]P 
      GO TO 900 
C     After reading - release lock and schedule BOSS if second copy used. 
200   IF(LFR.NE.2H]P) GO TO 900 
      IF(IPGST(6HBOSS  ).EQ.-1) GO TO 900 
      CALL RNRQ(4,IRNPRC,ISTAT) 
D     WRITE(LU,9904) IRNPRC,ISTAT 
      CALL EXEC(10,6HBOSS  ,2HPF) 
      GO TO 900 
C     Replacing procedure file. 
300   CONTINUE
C     Lock BOSS.
      IF(IPGST(6HBOSS  ).EQ.-1) GO TO 305 
      CALL RNRQ(1,IRNPRC,ISTAT) 
D     WRITE(LU,9903) IRNPRC,ISTAT 
C     Set name. 
305   LFR(2)=2HRC 
      LFR(3)=LP 
C     If file to be replaced is not current to BOSS, purge old and rename.
      IF(LP.NE.LSKD.AND.LP.NE.LPRC) 310,319 
310   LFR(1)=2H[P 
      CALL PURGE(IDCB1,IERR,LFR,0,ICRPRC) 
      CALL NAMF(IDCB2,IERR,LSF2,LFR,0,ICRPRC) 
C     Unlock BOSS.
      IF(IPGST(6HBOSS  ).EQ.-1) GO TO 900 
      CALL RNRQ(4,IRNPRC,ISTAT) 
D     WRITE(LU,9904) IRNPRC,ISTAT 
      GO TO 900 
319   CONTINUE
C     If file is second copy, purge old, rename, and schedule BOSS. 
      IF(LP.EQ.LNEWSK.OR.LP.EQ.LNEWPR) 320,329
320   LFR(1)=2H]P 
      CALL PURGE(IDCB1,IERR,LFR,0,ICRPRC) 
      CALL NAMF(IDCB2,IERR,LSF2,LFR,0,ICRPRC) 
      IF(IPGST(6HBOSS  ).EQ.-1) GO TO 900 
      CALL RNRQ(4,IRNPRC,ISTAT) 
D     WRITE(LU,9904) IRNPRC,ISTAT 
      CALL EXEC(10,6HBOSS  ,2HPF) 
      GO TO 900 
329   CONTINUE
C     If file is current to BOSS, rename to second copy, set flag, and
C     schedule BOSS.
      IF(LP.EQ.LSKD.OR.LP.EQ.LPRC) 330,339
330   LFR(1)=2H]P 
      CALL PURGE(IDCB2,IERR,LFR,0,ICRPRC) 
      CALL NAMF(IDCB2,IERR,LSF2,LFR,0,ICRPRC) 
      IF(LSKD.EQ.LP) LNEWSK=LP
      IF(LPRC.EQ.LP) LNEWPR=LP
      IF(IPGST(6HBOSS  ).EQ.-1) GO TO 900 
      CALL RNRQ(4,IRNPRC,ISTAT) 
D     WRITE(LU,9904) IRNPRC,ISTAT 
      CALL EXEC(10,6HBOSS  ,2HPF) 
      GO TO 900 
339   CONTINUE
C     Release lock after error opening or while reading.
400   CONTINUE
      IF(IPGST(6HBOSS  ).EQ.-1) GO TO 900 
      CALL RNRQ(4,IRNPRC,ISTAT) 
D     WRITE(LU,9904) IRNPRC,ISTAT 
      GO TO 900 
900   RETURN
      END 
