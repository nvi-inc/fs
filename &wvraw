FTN4,X
C@WVRAW 
C 
      SUBROUTINE WVRAW(IP),WVR RAW DATA C#870115:04:45# 
C 
C   WVRAW gets raw data from the WVR. 
C 
C   INPUT VARIABLES:
C 
      DIMENSION IP(1) 
C             -Parameters from QUIKR
C      IP(1)  -Class number of input buffer 
C      IP(2-5)-Not used 
C 
C   OUTPUT VARIABLES: 
C 
C      IP(1) - Class number 
C      IP(2) - Number of records
C      IP(3) - Error number 
C      IP(4) - Who we are 
C 
C   COMMON BLOCKS USED
C 
      INCLUDE #FSCOM::FS
C 
C   SUBROUTINE INTERFACE
C 
C   CALLING SUBROUTINE: QUIKR 
C   CALLED SUBROUTINES: CHARACTER STRING UTILITIES
C                       WVMOD - decode mode parameter 
C                       WVRDS - display raw data
C                       MD2WV - format mode request 
C                       WVGDT - get WVR data
C 
C   LOCAL VARIABLES 
C 
C     ICLCM - class number having the command in it 
C     NCHAR - number of characters in buffer
      DIMENSION IBUF(40)
C               - Input buffer holding command
      DIMENSION IREG(2) 
C               - Registers from EXEX calls 
      DIMENSION IPARM(2)
C               - Parameters from GTPRM calls 
      EQUIVALENCE (REG,IREG(1)) 
      EQUIVALENCE (PARM,IPARM(1)) 
C     MDE - mode, used locally
C 
C   INITIALIZED VARIABLES 
C 
      DATA ILEN/80/ 
C 
C   PROGRAMMER (ARIES)RBM 
C  LAST MODIFIED: 810403 BY NRV 
C                 830908 BY NRV - allow more samples
C 
C 
C     1. If class buffer contains command with "=", then process
C     the commanded mode. If only command name is present, then read
C     the current WVR mode and data from the radiometer.
C 
      ICLCM=IP(1) 
      IF(ICLCM.NE.0)GO TO 110 
      IERR=-1 
      GO TO 990 
  110 REG=EXEC(21,ICLCM,IBUF,-ILEN) 
      NCHAR = MIN0(IREG(2),ILEN)
      IEQ=ISCNC(IBUF,1,NCHAR,75B) 
C                  Scan for "=" 
      IF(IEQ.EQ.0)GO TO 500 
C                   If no parameters present, go read WVR mode and data 
      IF(ICHAR(IBUF,IEQ+1).NE.77B)GO TO 200 
      IP(4)=77B 
      CALL WVRDS(IP,ICLCM)
C                   If parameter is "?", get mode from common and display 
      RETURN
C 
C 
C     2. Step through the buffer getting each parameter and decoding it.
C     Command from the user has these parameters: 
C      JPL:    WVRAW=<mode>,<n>    where <mode>=HOT,BASE,ANT or ALL 
C                                        <n>=number of samples to take
C      Onsala: WVDAT=<mode>    where <mode>=RAW or ALL
C 
  200 ICH=IEQ+1 
      CALL GTPRM(IBUF,ICH,NCHAR,0,PARM) 
C                   Get first parameter, mode name
      IF(ICHAR(PARM,1).NE.52B.AND.ICHAR(PARM,1).NE.54B)GO TO 203
      IF(ICHAR(PARM,1).NE.52B)GO TO 201 
C                   Check for "*" indicating no change in mode
      MDE = MODEWV
C                   Pick up mode from common
      GO TO 210 
  201 IF(ICHAR(PARM,1).NE.54B)GO TO 203 
C                   No default mode is allowed
      IERR=-101 
      GO TO 990 
203   CALL WVMOD(PARM,MDE)
      IF(MDE.NE.-1)GO TO 210
C                   Commanded mode allowable? 
      IERR=-201 
      GO TO 990 
C 
210   CALL GTPRM(IBUF,ICH,NCHAR,1,PARM) 
      IF (ICHAR(PARM,1).NE.52B.AND.ICHAR(PARM,1).NE.54B) GOTO 213 
      IF (ICHAR(PARM,1).NE.52B) GOTO 211
      N = NRAWWV
C                     Pick up previous value in common
      GOTO 300
211   N = 10
      IF (MDE.EQ.4) N=5 
C                     Default is 10  (5 FOR ALL)
      GOTO 300
213   IF (MDE.LT.4.AND.IPARM.GT.0.AND.IPARM.LE.256) GOTO 214
      IF (MDE.EQ.4.AND.IPARM.GT.0.AND.IPARM.LE. 80) GOTO 214
      IERR = -102 
C                     Too many samples, or <= zero
      GOTO 990
214   N=IPARM 
C 
C 
C     3. Put the parameters into common, since everything passed OK.
C     Format the buffer holding the command to set the mode.
C 
300   NRAWWV = N
      MODEWV=MDE
      CALL MD2WV(IBUF,MODEWV,NRAWWV,ICLASS,NREC,IERR) 
      IF (IERR.NE.0) GOTO 990 
      GOTO 800
C 
C 
C     5. This is the place where we format the buffer for the 
C     command which gets back data from the WVR.
C 
500   CALL WVGDT(IBUF,ICLASS,NREC)
C 
C 
C     8. Schedule MATCN to do the communications. 
C 
800   CALL EXEC(23,6HMATCN ,ICLASS,NREC)
      CALL RMPAR(IP)
      CALL WVRDS(IP,ICLCM)
      RETURN
C 
C     9. Error exit 
C 
  990 IP(1)=0 
      IP(2)=0 
      IP(3)=IERR
      IP(4)=2HQW
      RETURN
      END 
