FTN4,X
C@WVSDS 
C 
      SUBROUTINE WVSDS(IP,ICLCM),WVR STATUS DISPLAY, C#870115:04:47#
C 
C   WVSDS displays the current status  from the WVR 
C 
C  MODIFICATIONS: 
C 
C  830908 NRV CREATED 
C 
C     INPUT VARIABLES:
C 
      DIMENSION IP(1) 
C        IP(1)  - class number of buffer from MATCN 
C        IP(2)  - # records in class
C        IP(3)  - error return from MATCN 
C        IP(4)  - who, or 77B (?) 
C        IP(5)  - class with command
C 
C     OUTPUT VARIABLES: 
C 
C        IP(1) - error
C        IP(2) - class
C        IP(3) - number of records
C        IP(4) - who we are 
C 
C  COMMON BLOCKS USED 
C 
      INCLUDE #FSCOM::FS
C 
C   SUBROUTINE INTERFACE: 
C 
C     CALLING SUBROUTINES: WVSTA
C     CALLED SUBROUTINES: character utilities 
C                         WV2ST - convert WVR response to integers
C 
C  LOCAL VARIABLES
C 
      DIMENSION IBUF1(40),IBUF2(50) 
C               - input class buffer, output display buffer 
C        ILEN,ILEN2   - length of buffers, chars
C        NCH    - character counter 
      DIMENSION LPNT(12),LDAT(12),LMOD(10)
      DIMENSION NPNT(3),NDAT(3),NMOD(5) 
C         - status words for pointing, data taking, mode
C         - number of char. 
      LOGICAL KCOM,KDATA
C      - KCOM is true if we only want the ID   from common
C      - KDATA is true if we are getting data from the WVR
      DIMENSION IREG(2) 
C               - registers from EXEC 
      EQUIVALENCE (REG,IREG(1)) 
C 
C 
C   INITIALIZED VARIABLES 
C 
      DATA LPNT/2HST,2HOP,2HPE,2HD ,2HMO,2HVI,2HNG,2H  ,
     .2HAB,2HOR,2HTE,2HD /
      DATA NPNT/7,5,7/
      DATA LDAT/2HRE,2HAD,2HY ,2H  ,2HTA,2HKI,2HNG,2H  ,
     .2HAB,2HOR,2HTE,2HD /
      DATA NDAT/5,6,7/
      DATA LMOD/2HHU,2HH?,2HHO,2HT ,2HBA,2HSE,2HAN,2HT ,2HAL,2HL /
      DATA NMOD/4,3,3,4,3/
      DATA ILEN2/100/,ILEN/80/  
C 
C 
C     1. Determine whether parameters from COMMON wanted and skip to
C     response section. 
C     Get RMPAR parameters and check for errors from our I/O request. 
C 
      KCOM = IP(4).EQ.77B 
C 
      ICLASS = IP(1)
      NCREC = IP(2) 
      IERR = IP(3)
C 
      IF (KCOM) GOTO 200
      IF (IERR.LT.0) GOTO 990 
      IF (ICLASS.EQ.0.OR.ICLCM.EQ.0) GOTO 990 
C 
C 
C     2. Get class buffer with command in it.  Set up first part
C     of output buffer. 
C 
200   REG = EXEC(21,ICLCM,IBUF2,-ILEN2) 
      NCHAR = MIN0(IREG(2),ILEN2) 
      NCH = ISCNC(IBUF2,1,NCHAR,75B)
C                   Scan for "="
      KDATA = NCH.EQ.0
C                   If our command was only "device" we are waiting for 
C                   data and know what to expect. 
      IF (NCH.EQ.0) NCH = NCHAR+1 
C                   If no "=" found, position after last character
      NCH = ICHMV(IBUF2,NCH,2H/ ,1,1) 
C                   Put / to indicate a response
C 
      IF (KCOM.OR.KDATA) GOTO 230 
C 
C     2.1 The response is merely an acknowledgement.
C     Transfer the response directly into output buffer.
C 
      DO 220 I=1,NCREC
        IF (I.NE.1) NCH=MCOMA(IBUF2,NCH)
C                   If not first parm, put comma before 
        REG = EXEC(21,ICLASS,IBUF1,-ILEN) 
        NCHAR = MIN0(IREG(2),ILEN)
        NCH = ICHMV(IBUF2,NCH,IBUF1(2),1,NCHAR-2) 
C                   Move buffer contents into output list 
220     CONTINUE
      NCH = NCH - 1 
      GOTO 500
C 
C     2.3 There is real data in the response. 
C     Get the data and format the response. 
C 
230   IF (KCOM) GOTO 235
      REG = EXEC(21,ICLASS,IBUF1,-ILEN) 
      CALL WV2ST(IBUF1(2),IERR,IERR2,ISTPNT,ISTDAT,IID,ISMUX, 
     .NSAMP,IMODE)
      GOTO 236
C                   Decode the data buffer
235   IID = IDWVR 
236   NCH=NCH + IB2AS(IID,IBUF2,NCH,1)
      IF (KCOM) GOTO 500
      NCH = MCOMA(IBUF2,NCH)
      NCH = ICHMV(IBUF2,NCH,LPNT,1+8*ISTPNT,NPNT(ISTPNT+1)) 
      NCH = MCOMA(IBUF2,NCH)
      NCH = ICHMV(IBUF2,NCH,LDAT,1+8*ISTDAT,NDAT(ISTDAT+1)) 
      NCH = MCOMA(IBUF2,NCH)
      NCH = ICHMV(IBUF2,NCH,LMOD,1+4*IMODE ,NMOD  (IMODE +1)) 
C 
C 
C     5. Log the response and we're done. 
C 
500   ICLASS = 0      
      CALL EXEC(20,0,IBUF2,-NCH,2HFS,0,ICLASS)
      NREC = 1
      IERR = 0
C 
      IP(1) = ICLASS
      IP(2) = NREC
      IP(3) = IERR
      IP(4) = 2HQW
      IP(5) = 0 
990   RETURN
      END 
