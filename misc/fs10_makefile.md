FS 10 Makefile notes
====================

Intro
-----

The Makefile structure for FS 10 has been updated from previous versions. This is to make setting build flags easier across the system, improve make's ability to detect
changes in dependencies and rebuild.

The new Makefile structure is similar to the old version, using recursive make triggered from top directory makefile. That is, each directory has its own Makefile which
is called from the top-level with the default target. This Makefile is responsible for building the contents of this subdirectory how-ever that needs to be interpreted.
For most cases, the boiler-plate of this file can be, and generally *should* be, removed by including the "include.mk" in the root directory of the FS tree. This will
ensure preprocessor/compiler/linker flags are set and also specifies default rules for most files, including binaries to be built in the "fs/bin" directory.

In the top level Makefile library and binary directories are listed separately, and all the binary directories are made to depend on all the library directories to ensure libraries are built first (if needed).

The features are all opt-in in sub-directories. That is, directories can follow a different convention without breaking the build. Examples in FS 10 are third_party and drudg.


Usage
-----

If a subdirectory Makefile is using the new system, it must follow these rules:

-   The line "include ../include.mk" must be added and come after the main targets
-   All targets by should be specified in the TARGETS variable
-   All objects should be specified in the OBJECTS variable
-   Executable targets should follow the form:

        ../bin/target: $(OBJECTS) $(LIBS)

-   Executable targets should not override the default rules.
-   Standard GNU-make variables must be used for specifying preprocessor, compiler, and linker flags:

	-   LDLIBS for system libraries, eg:

			LDLIBS = -lm -lcurses

	-   CFLAGS for compiler flags. It is unlikely this will need to be set for an individual target. Instead, probably modify CPPFLAGS

	-   CPPFLAGS for preprocessor flags, eg:

			CPPFLAGS += -I./include

	-   LIBS should for local (FS) libraries dependencies, eg:

		LIBS = ../poclb/poclb.a ../clib/clib.a ../rtelb/rtelb.a

-  If the subdirectory contains executables with Fortran code, the Makefile must append FLIBS to LDLIBS:

		LDLIBS += $(FLIBS)

	(This can also be done per target if need-be)
	

The first is important for the default "clean" rule to work correctly. (TODO: maybe a default clean rule is too prescriptive)

The second is important for the dependency generation

Dependency files
----------------
Dependency files are generated makefiles that list the header dependencies of a C file. These are automatically generated by the GCC compiler and included in the main Makefile. This way if the headers are updated the file will rebuilt. These dependency files are kept up to date as the include directives change.

-  `make dist` could use `git archive`
