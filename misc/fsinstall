echo "*******************************************************************"
echo "*  This is the INSTALLATION script for Field System version $FS_VERSION *"
echo "*  This script must be excuted by root to work correctly.         *"
echo "*  Refer to instructions in the Update Notice.                    *"
echo "*******************************************************************"
echo ""
if [ ! $FS_VERSION ]; then
   echo "This script must be run by 'make install' in '/usr2/fs', aborting."
   exit
fi
echo "CAUTION: This script will automatically modify some of your directories."
echo ""
echo "On /usr2 each of the following directories will be created and filled"
echo "with their default contents, unless they already exist: oper, prog,"
echo "control, sched, proc, log, and st. If the /usr2/oper directory is created,"
echo "the /home/oper directory will be copied to /home/oper.FSCOPY (unless it"
echo "exists already), and /home/oper will be made a link to /usr2/oper. A"
echo "parallel operation will occur for /usr2/prog. The link /usr2/fs" will
echo "be deleted and made to point to this version of the Field System. A"
echo "similar link structure will be used for /usr2/st. The permissions and"
echo "ownerships of the files will be set (including for /etc/gpib.conf)."
echo ""
echo "This is a fairly benign operation on most systems and always safe on a"
echo "standard system. To get the default versions of any already existing"
echo "directories, you will need to delete them before continuing with this"
echo "script."
echo ""
echo -e "Do you wish to continue with the INSTALLATION? (y=yes, n=no) : \c" 
badans=true
while [ "$badans" = "true" ]
do
  read ans
  case "$ans" in
    y|yes) echo -e "\nO.K. Continuing with install ... "
           badans=false
           ;;
    n|no)  echo -e "\nO.K. Exiting."
           exit
           ;;
    *)     echo -e "\nPlease answer with y=yes or n=no : \c"
  esac
done
#
echo "Creating /usr2/fs directory link ..."
cd /usr2
if [ -L fs ]; then
  rm -rf fs
fi
if [ -e fs ]; then
  echo "/usr2/fs exists and is not a just link. I can't continue without"
  echo "possibly destroying your data. Please move or remove /usr2/fs."
  exit
fi
ln -s fs-$FS_VERSION fs
#
echo "Setting /usr2/fs permissions ..."
cd /usr2
chown -R prog fs fs-$FS_VERSION
chgrp -R rtx fs fs-$FS_VERSION
chmod -R a+r,u+w,go-w fs fs-$FS_VERSION
#
if [ ! -e st-0.0.0 -a ! -e st ]; then
  echo "Creating /usr2/st default directory structure..."
  mkdir /usr2/st-0.0.0
  cd /usr2/fs/st.default/st-0.0.0
  find Makefile misc help bin -print|cpio -pmdu /usr2/st-0.0.0
  cd /usr2
  rm -f st
  ln -s st-0.0.0 st
  chown -R prog st st-0.0.0
  chgrp -R rtx  st st-0.0.0
  chmod -R a+r,u+w,go-w st st-0.0.0
fi
#
if [ ! -e /usr2/oper ]; then
   echo "Setting up /usr2/oper ..."
   if [ -e /home/oper.FSCOPY -o -L /home/oper.FSCOPY ]; then
      if [ -e /home/oper -o -L /home/oper ]; then
         echo "/home/oper.FSCOPY already exists. Please move or remove it."
         exit
      fi
   fi
   cd /usr2/fs/st.default
   find oper -print|cpio -pmdu /usr2
   chown -R oper /usr2/oper
   chgrp -R rtx  /usr2/oper
   chmod -R a+r,u+w,go-w /usr2/oper
   cd /home
   if [ -e oper -o -L oper ]; then
      mv oper oper.FSCOPY
   fi
   ln -s /usr2/oper oper
fi
#
if [ ! -e /usr2/prog ]; then
   echo "Setting up /usr2/prog ..."
   cd /usr2/fs/st.default
   find prog -print|cpio -pmdu /usr2
   chown -R prog /usr2/prog
   chgrp -R rtx  /usr2/prog
   chmod -R a+r,u+w,go-w /usr2/prog
   cd /home
   if [ ! -e prog.FSCOPY ]; then
      mv prog prog.FSCOPY
   fi
   ln -s /usr2/prog prog
fi
#
if [ ! -e /usr2/control ]; then
   echo "Setting up /usr2/control ..."
   cd /usr2/fs/st.default
   find control -print|cpio -pmdu /usr2
   chown -R oper /usr2/control
   chgrp -R rtx  /usr2/control
   chmod -R a+rw /usr2/control
fi
#
if [ ! -e /usr2/proc ]; then
   echo "Setting up /usr2/proc ..."
   cd /usr2/fs/st.default
   find proc/station.prc -print|cpio -pmdu /usr2
   chown -R oper /usr2/proc
   chgrp -R rtx  /usr2/proc
   chmod -R a+rw /usr2/proc
fi
#
if [ ! -e /usr2/sched ]; then
   echo "Setting up /usr2/sched ..."
   cd /usr2/fs/st.default
   find sched -print|cpio -pmdu /usr2
   chown -R oper /usr2/sched
   chgrp -R rtx  /usr2/sched
   chmod -R a+rw /usr2/sched
fi
#
if [ ! -e /usr2/log ]; then
   echo "Setting up /usr2/log ..."
   mkdir /usr2/log
   chown -R oper /usr2/log
   chgrp -R rtx  /usr2/log
   chmod -R a+rw /usr2/log
fi
#
if [ -e /etc/gpib.conf ]; then
   echo "Setting permissions for /etc/gpib.conf ..."
   cd /etc
   chown root         gpib.conf
   chgrp rtx          gpib.conf
   chmod a+r,ug+w,o-w gpib.conf
fi
#
echo "Done."
