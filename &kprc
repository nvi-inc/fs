FTN4
C@KPRC
C 
      FUNCTION KPRC(ILU,NSECT,IDTRK,IBUF,MODE,JDTRK,JDSEC,JOFST,
     .LNAM,JXTNT),PROCEDURE SEARCH C#870115:05:41 
C 
C     KPRC
C 
C 1.  KPRC PROGRAM SPECIFICATION
C 
C 1.1.   KPRC searches a cartridge directory for files beginning with the 
C        procedure prefix "[PRC". 
C 
C 1.2.   RESTRICTIONS - not tested on M system
C 
C 1.3.   REFERENCES - Field system manual 
C 
C 2.  KPRC INTERFACE
C 
C 2.1.   CALLING SEQUENCE: K=KPRC(ILU,NSECT,IDTRK,IBUF,MODE,JDTRK,JDSEC,JOFST,
C                                 LNAM,JXTNT) 
C 
C     INPUT VARIABLES:
C 
C        ILU    - LU to be searched 
C        NSECT  - sectors per track on ILU
C        IDTRK  - first directory track on ILU
C        MODE   - 0 = start at beginning of directory 
C               - <>0 = start at entry specified by JDTRK, JDSEC, JOFST 
C        JDTRK, JDSEC, JOFST - track, sector, offset for search start 
      DIMENSION IBUF(16,8)
C               - buffer for sector read from directory 
C 
C     OUTPUT VARIABLES: 
C 
C        JDTRK, JDSEC, JOFST - track, sector, offset of file entry found
C        JXTNT  - extent number 
      DIMENSION LNAM(3) 
C               - procedure file name 
C 
C 2.2.   COMMON BLOCKS USED: none 
C 
C 2.3.   DATA BASE ACCESSES: none 
C 
C 2.4.   EXTERNAL INPUT/OUTPUT: none
C 
C 2.5.   SUBROUTINE INTERFACE:
C 
C     CALLING SUBROUTINES: FFM
C 
C     CALLED SUBROUTINES: EXEC, MOD, JSHFT, ICHAR 
C 
C 3.  LOCAL VARIABLES 
C 
C        ISEC1  - starting search sector in directory 
C        INIT   - flag for first search (1 - first, 0 - next) 
C        INIR   - flag for search restart (1 - at restart entry,
C                 0 - not at restart entry) 
C        LDTRK  - last directory track
C        IE1    - initial entry count within sector 
C        ISECC  - total sector count
C        ITYPE  - file type - used as flag
C        IE     - entry count within sector 
C 
C 4.  CONSTANTS USED
C 
      DATA LP1 /2H[P/, LP2 /2HRC/ 
C               - procedure prefix "[PRC" 
C 
C 5.  INITIALIZED VARIABLES: none 
C 
C 6.  PROGRAMMER: C. Ma 
C     LAST MODIFIED:
C# LAST COMPC'ED  870115:05:41 #
C 
C     PROGRAM STRUCTURE 
C 
      KPRC=0
      ISEC1=0 
      INIT=1
      INIR=0
      IF (ILU .GE. 2 .AND. NSECT .GE. 96) ISEC1=14
C     There is no offset for RTE-IVB
      IF (IOPSY(IDUM).EQ.8) ISEC1=0 
C     Get last directory track. 
      REG=EXEC(1,ILU,IBUF,128,IDTRK,ISEC1)
      LDRTRK=IBUF(8)
      IF (MODE .EQ. 0) GO TO 50 
      INIR=1
      ISEC1=JDSEC 
      IE1=JOFST/16+1
      GO TO 80
C     Start search from beginning of directory. 
50    IE1=2 
      JDTRK=IDTRK 
C     Initiate search.
80    DO 250 ISECC=ISEC1,32000,14 
      JDSEC=MOD(ISECC,NSECT)
      IF (INIT .EQ. 0 .AND. JDSEC .EQ. 0) JDTRK=JDTRK-1 
      INIT=0
      IF (JDTRK .LT. LDRTRK) GO TO 900
      REG=EXEC(1,ILU,IBUF,128,JDTRK,JDSEC)
      DO 200 IE=IE1,8 
C     Check for end of directory. 
      IF (IBUF(1,IE) .EQ. 0) GO TO 150
C     Check for deleted file. 
      IF (IBUF(1,IE) .EQ. -1) GO TO 200 
C     Ignore type 0 files.
      ITYPE=IBUF(4,IE)
      IF (ITYPE .EQ. 0) GO TO 200 
C     Get extent. 
      JXTNT=JSHFT(IBUF(6,IE),8) 
C     Check for procedure prefix. 
      IF (IBUF(1,IE) .NE. LP1 .OR. IBUF(2,IE) .NE. LP2) GO TO 200 
C     Check if at restarting point. 
      IF (INIR .EQ. 1) GO TO 190
      LNAM=IBUF(3,IE) 
      KPRC=ITYPE
150   JOFST=(IE-1)*16 
      GO TO 900 
190   INIR=0
200   CONTINUE
      IE1=1 
250   CONTINUE
900   RETURN
      END 
